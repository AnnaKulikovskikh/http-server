(()=>{"use strict";class t{constructor(t,e,s,i){this.name=e,this.time=i,this.id=t,this.status=s}createTicket(){const t=document.createElement("li");let e;t.classList.add("item"),t.dataset.id=this.id,e=this.status?'<input type="checkbox" class="item__checkbox" checked>':'<input type="checkbox" class="item__checkbox">';const s=document.createElement("div");s.classList.add("item__content");const i=document.createElement("div");i.classList.add("item__name"),i.textContent=this.name,s.append(i);const n=`<time class="item__time" datetime="03-07-2021">${this.time}</time>`,o=document.createElement("div");return o.classList.add("item__control"),o.innerHTML='<button type="button" class="item__edit btn">&#9998</button>\n          <button type="button" class="item__delete btn">X</button>',t.insertAdjacentHTML("beforeend",e),t.append(s),t.insertAdjacentHTML("beforeend",n),t.append(o),t}}function e(t,e,s=null,i=null){const n="https://cursar-heroku.herokuapp.com/";return new Promise(((o,a)=>{const c=new XMLHttpRequest;s?c.open(t,`${n}?method=${e}&id=${s}`):c.open(t,`${n}?method=${e}`),c.responseType="json",c.setRequestHeader("Content-Type","application/json"),c.onload=()=>{c.status>=400?a(c.response):o(c.response)},c.onerror=()=>{a(c.response)},c.send(JSON.stringify(i))}))}(new class{constructor(){this.container=document.querySelector(".container"),this.modal=document.querySelector(".modal"),this.form=document.querySelector(".form")}init(){this.container.addEventListener("click",(t=>this.onClick(t))),this.container.addEventListener("change",(t=>this.onChange(t))),this.onLoading()}onLoading(){this.container.querySelector("ul").innerHTML="",e("GET","allTickets",null,{}).then((e=>{e.forEach((e=>{const{id:s,name:i,status:n,time:o}=e,a=new t(s,i,n,o);this.container.querySelector("ul").append(a.createTicket())}))})).catch((t=>{throw new Error(t)}))}onClick(t){if(t.target.classList.contains("add__ticket")&&this.openModal("Добавить тикет"),t.target.classList.contains("item__edit")){const{id:e}=t.target.closest(".item").dataset;this.editTicket(e)}if(t.target.classList.contains("item__delete")){const{id:e}=t.target.closest(".item").dataset;this.deleteTicket(e)}if(t.target.classList.contains("cansel")&&(this.modal.classList.remove("active"),this.form.reset()),t.target.classList.contains("ok")){if(t.preventDefault(),""===this.form.name.value||""===this.form.description.value)throw new Error("Empty field");{const t=Object.assign(this.getData(),{status:!1,time:this.getTime()});if(this.form.dataset.id){const{id:e}=this.form.dataset;this.addTicket(t,e)}else this.addTicket(t,null)}}if(t.target.classList.contains("item__name"))if(t.target.nextElementSibling)t.target.nextElementSibling.remove();else{const{id:e}=t.target.closest(".item").dataset;this.getDescription(e,t.target)}}onChange(t){if(t.target.classList.contains("item__checkbox")){const e={status:t.target.checked},{id:s}=t.target.closest(".item").dataset;this.addTicket(e,s)}}addTicket(t,s){s?e("POST","createTicket",s,t).then((t=>{t&&(this.form.reset(),this.form.removeAttribute("data-id"),this.modal.classList.remove("active"),this.onLoading())})).catch((t=>{throw new Error(t)})):e("POST","createTicket",null,t).then((t=>{t&&(this.form.reset(),this.modal.classList.remove("active"),this.onLoading())})).catch((t=>{throw new Error(t)}))}editTicket(t){e("GET","ticketById",t,{}).then((e=>{const{name:s,description:i}=e;this.openModal("Редактировать тикет"),this.form.dataset.id=t,this.form.name.value=s,this.form.description.value=i})).catch((t=>{throw new Error(t)}))}getDescription(t,s){e("GET","ticketById",t,{}).then((e=>{const{description:i}=e;this.addDescription(t,s,i)})).catch((t=>{throw new Error(t)}))}addDescription(t,e,s){const i=document.createElement("div");i.classList.add("item__description"),i.textContent=s,e.closest(".item__content").append(i)}openModal(t){this.modal.classList.add("active"),this.form.querySelector(".form-title").textContent=t}getTime(){const t=new Date;return`${t.getDate()}.${t.getMonth()+1}.${t.getFullYear()} ${t.getHours()}:${t.getMinutes()}`}getData(){const t=new FormData(this.form).entries(),e={};for(const s of t)e[s[0]]=s[1];return e}deleteTicket(t){e("DELETE","delTicketById",t,{}).then((t=>{t&&this.onLoading()})).catch((t=>{throw new Error(t)}))}}).init()})();